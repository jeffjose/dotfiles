#!/bin/bash
#
#
set -e # Exit on error

# Constants
DOTFILES_DIR="$HOME/dotfiles"
BACKUP_SUFFIX=".bak.$(date +%Y%m%d_%H%M%S)"

# Directories to create
DIRECTORIES=(
  "$HOME/bin"
  "$HOME/scripts"
  "$HOME/Downloads"
  "$HOME/.screen"
  "$HOME/.config/nvim"
  "$HOME/.local/share/nvim/backup"
  "$HOME/.config/espanso"
  "$HOME/.config/containers"
  "$HOME/.config/Code/User"
  "$HOME/.ipython/profile_default"
  "$HOME/.screenlayout"
  "$HOME/.jupyter/custom"
  "$HOME/.config/mise"
  "$HOME/.config/uv"
  "$HOME/.pnpm"
  "$HOME/.config/ranger"
  "$HOME/.config"
)

# Files to symlink (source:target)
declare -A SYMLINKS=(
  ["$DOTFILES_DIR/shell/.aliases"]="$HOME/.aliases"
  ["$DOTFILES_DIR/shell/.aliases.bash"]="$HOME/.aliases.bash"
  ["$DOTFILES_DIR/apps/.colordiffrc"]="$HOME/.colordiffrc"
  ["$DOTFILES_DIR/shell/.cshrc"]="$HOME/.cshrc"
  ["$DOTFILES_DIR/shell/.cwdcmd"]="$HOME/.cwdcmd"
  ["$DOTFILES_DIR/git/.gitconfig"]="$HOME/.gitconfig"
  ["$DOTFILES_DIR/editors/.pdbrc"]="$HOME/.pdbrc"
  ["$DOTFILES_DIR/shell/.precmd"]="$HOME/.precmd"
  ["$DOTFILES_DIR/shell/.prompt"]="$HOME/.prompt"
  ["$DOTFILES_DIR/shell/.screen/default"]="$HOME/.screen/default"
  ["$DOTFILES_DIR/shell/.screenrc"]="$HOME/.screenrc"
  ["$DOTFILES_DIR/shell/.tabletaliases"]="$HOME/.tabletaliases"
  ["$DOTFILES_DIR/editors/nvim/init.vim"]="$HOME/.vimrc"
  ["$DOTFILES_DIR/editors/nvim/init.vim"]="$HOME/.config/nvim/init.vim"
  ["$DOTFILES_DIR/editors/nvim/plugins.vim"]="$HOME/.config/nvim/plugins.vim"
  ["$DOTFILES_DIR/desktop/.XResources"]="$HOME/.XResources"
  ["$DOTFILES_DIR/desktop/.xmodmap"]="$HOME/.xmodmap"
  ["$DOTFILES_DIR/desktop/.xsession"]="$HOME/.xsession"
  ["$DOTFILES_DIR/editors/keybindings.json"]="$HOME/.config/Code/User/keybindings.json"
  ["$DOTFILES_DIR/apps/ipython_config.py"]="$HOME/.ipython/profile_default/ipython_config.py"
  ["$DOTFILES_DIR/apps/custom.js"]="$HOME/.jupyter/custom/custom.js"
  ["$DOTFILES_DIR/apps/default.yml"]="$HOME/.config/espanso/default.yml"
  ["$DOTFILES_DIR/apps/containers.conf"]="$HOME/.config/containers/containers.conf"
  ["$DOTFILES_DIR/apps/.jq"]="$HOME/.jq"
  ["$DOTFILES_DIR/apps/config.toml"]="$HOME/.config/mise/config.toml"
  ["$DOTFILES_DIR/apps/uv/uv.toml"]="$HOME/.config/uv/uv.toml"
  ["$DOTFILES_DIR/apps/audtag.yaml"]="$HOME/audtag.yaml"
  ["$DOTFILES_DIR/apps/ranger/rc.conf"]="$HOME/.config/ranger/rc.conf"
  ["$DOTFILES_DIR/apps/ranger/rifle.conf"]="$HOME/.config/ranger/rifle.conf"
  ["$DOTFILES_DIR/shell/.tmux.conf"]="$HOME/.tmux.conf"
  ["$DOTFILES_DIR/shell/.bashrc"]="$HOME/.bashrc"
  ["$DOTFILES_DIR/shell/starship.toml"]="$HOME/.config/starship.toml"
)

# Track failures
declare -a failed_tasks=()

# Function to run a task and track its success/failure
run_task() {
  local task_name="$1"
  shift
  if "$@" 2>/dev/null; then
    echo "âœ“ $task_name"
    return 0
  else
    echo "âœ— $task_name"
    failed_tasks+=("$task_name")
    return 1
  fi
}

echo "ğŸš€ Setting up dotfiles in $HOME"
echo "-----------------------------------"

# Create directories
echo -e "\nğŸ“ Directories"
for dir in "${DIRECTORIES[@]}"; do
  run_task "  $dir" mkdir -p "$dir"
done

# Create empty files
echo -e "\nğŸ“„ Files"
run_task "  /tmp/cwdcmd_recent_dirs" touch /tmp/cwdcmd_recent_dirs
run_task "  $HOME/.aliases.sensitive.sh" touch "$HOME/.aliases.sensitive.sh"

# Setup screen symlink
echo -e "\nğŸ”— Screen"
if [ -L "$HOME/bin/scrn" ] && [ "$(readlink "$HOME/bin/scrn")" = "/usr/bin/screen" ]; then
  echo "  (no changes)"
else
  run_task "  $HOME/bin/scrn â†’ /usr/bin/screen" ln -sf /usr/bin/screen "$HOME/bin/scrn"
fi

# Symlink bin scripts
echo -e "\nğŸ”— Bin scripts"
bin_count=0
for script in "$DOTFILES_DIR/bin/"*; do
  [ -f "$script" ] || continue
  script_name=$(basename "$script")
  target="$HOME/bin/$script_name"
  # Skip if symlink already points to correct target
  if [ -L "$target" ] && [ "$(readlink "$target")" = "$script" ]; then
    continue
  fi
  run_task "  $target â†’ bin/$script_name" ln -sf "$script" "$target"
  ((bin_count++)) || true
done
[ $bin_count -eq 0 ] && echo "  (no changes)"

# Create symlinks
echo -e "\nğŸ”— Symlinks"
symlink_count=0
for src in "${!SYMLINKS[@]}"; do
  target="${SYMLINKS[$src]}"
  # Skip if symlink already points to correct target
  if [ -L "$target" ] && [ "$(readlink "$target")" = "$src" ]; then
    continue
  fi
  if [ -e "$target" ] && [ ! -L "$target" ]; then
    run_task "  $target (backup)" mv "$target" "$target$BACKUP_SUFFIX"
  fi
  run_task "  $target â†’ $(basename "$src")" ln -sf "$src" "$target"
  ((symlink_count++)) || true
done
[ $symlink_count -eq 0 ] && echo "  (no changes)"

if [ ${#failed_tasks[@]} -gt 0 ]; then
  echo -e "\nâŒ Failed tasks:"
  printf '%s\n' "${failed_tasks[@]}"
  exit 1
else
  echo -e "\nâœ¨ Done!"
fi
